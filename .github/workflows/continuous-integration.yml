name: Salesforce CI/CD Logic

# This workflow can ONLY be called from another repository
on:
  workflow_call:
    inputs:
      target-env:
        description: 'Salesforce Target Environment Alias (e.g., sandbox, prod)'
        required: true
        type: string
      deployment-mode:
        description: 'Deployment Mode (DELTA or FULL)'
        required: true
        type: string
      test-level:
        description: 'Test Level (NoTestRun, RunLocalTests, RunSpecifiedTests)'
        required: false
        type: string
      check-only:
        description: 'Run deployment as check-only (validation)'
        required: true
        type: boolean
      outputdir:
        description: 'Output directory for artifacts'
        required: false
        type: string
        default: 'results'
      change-detection-type:
        description: 'Metadata type for test class detection (e.g., classes, all)'
        required: false
        type: string
        default: 'classes'
      test-class-regex: 
        description: 'Regex for matching test class names'
        required: false
        type: string
        default: '.*Test.*$'
      org-preconfig:
        description: 'Run pre-deployment org configuration data step'
        required: false
        type: boolean
        default: false # Set a default value
      run-code-scanner:
        description: 'Run Salesforce code analyzer'
        required: false
        type: boolean
        default: false # Set a default value
    secrets: 
      AUTH_URL:
        required: true
jobs:
  salesforce_ci:
    runs-on: ubuntu-latest
    container: brovasi/dxb
    environment: ${{ inputs.target-env }}

    env:
      # Map inputs to environment variables used in the script
      TARGET_ENV: ${{ inputs.target-env }}
      DEPLOYMENT_MODE: ${{ inputs.deployment-mode }}
      CHECK_ONLY: ${{ inputs.check-only }}
      OUTPUT_DIR: ${{ inputs.outputdir }}
      CHANGE_DETECTION_TYPE: ${{ inputs.change-detection-type }}
      TEST_CLASS_REGEX: ${{ inputs.test-class-regex }}

    steps:
    
      - name: â¬‡ï¸ Checkout Repository (Salesforce Project)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ðŸ”‘ Initialize Pipeline
        run: |
          # ðŸŽ¯ FIX: No dollar sign on the left side, and no space around the equals sign.
          # We are setting NEW shell variables here, NOT overriding existing environment variables.
          
          # Set COMPARE_WITH based on check-only
          COMPARE_WITH="${{ inputs.check-only == true && vars.VAL_COMPARE_WITH || vars.DEP_COMPARE_WITH }}"
          
          # Set DELTA_MODE based on check-only (using the ternary operator)
          DELTA_MODE="${{ inputs.check-only == true && vars.VAL_DELTA_MODE || vars.DEP_DELTA_MODE }}"
          
          # Set TEST_LEVEL using the nested condition
          TEST_LEVEL="${{ inputs.test-level != '' && inputs.test-level || (inputs.check-only == true && vars.VAL_TEST_LEVEL || vars.DEP_TEST_LEVEL) }}"
          
          # Export these variables so they are available to subsequent commands
          # (Optional, but good practice if you have more commands in this script)
          echo "COMPARE_WITH=$COMPARE_WITH" >> $GITHUB_ENV
          echo "DELTA_MODE=$DELTA_MODE" >> $GITHUB_ENV
          echo "TEST_LEVEL=$TEST_LEVEL" >> $GITHUB_ENV
          
          echo "DEPLOYMENT MODE: $DEPLOYMENT_MODE"
          echo "DELTA MODE: $DELTA_MODE"
          echo "COMPARE WITH: $COMPARE_WITH"
          echo "TEST LEVEL: $TEST_LEVEL"
          
          npm install --save-dev
          sf plugins link $(npm root -g)/dxb
          sf plugins
          git config --global --add safe.directory $PWD
        shell: bash
          
      # 1. Login to Salesforce (using the common, fixed secret AUTH_URL)
      - name: ðŸ”‘ Salesforce Login
        run: |
          AUTH_URL_VALUE="${{ secrets.AUTH_URL }}"
          
          if [ -z "$AUTH_URL_VALUE" ]; then
            echo "::error::SFDX Auth URL secret not found. Ensure the calling workflow passes the secret via the 'SFDX_AUTH_URL' key."
            exit 1
          fi
          
          echo "$AUTH_URL_VALUE" > credentials.txt
          # Use the environment variable $TARGET_ENV
          sf org login sfdx-url -f credentials.txt -a $TARGET_ENV -s
        shell: bash
      # 2. Run Delta
      - name: ðŸ§® Calculate Delta
        run: |
          # Use environment variables which are easier to read and less error-prone
          if [ "$DEPLOYMENT_MODE" = "FULL" ]
          then
            echo "--- Full Deployment Mode ---"
            allPackageDirectories=""
            json=$(cat sfdx-project.json)
            for i in $(echo "$json" | jq -r '.packageDirectories[].path'); do
              allPackageDirectories+=" --source-dir $i"
            done
            echo "sf project generate manifest $allPackageDirectories -d $OUTPUT_DIR"
            sf project generate manifest $allPackageDirectories -d $OUTPUT_DIR
            
            # Setup for full deployment tests
            echo "./**/*.cls" > apexclasses
            echo "" > testClasses
            echo "::set-output name=noChanges::false" # Force deployment if FULL mode

          else # DELTA Deployment Mode
            echo "--- Delta Deployment Mode (Comparing with $COMPARE_WITH) ---"
            #increase git file name config
            #git config diff.renameLimit 999999
            
            # 1. Generate package.xml and check for changes
            echo "sf dxb source delta -m $DELTA_MODE -k $COMPARE_WITH -p $OUTPUT_DIR -g"
            sf dxb source delta -m $DELTA_MODE -k $COMPARE_WITH -p $OUTPUT_DIR -g
            
            # Check if package.xml contains actual metadata members
            if ! grep -q '<members>' "$OUTPUT_DIR/package.xml"; then
              echo "No changes detected. Skipping deployment."
              echo "::set-output name=noChanges::true"
              exit 0
            fi

            # 2. Extract Apex classes and test classes for specified tests
            sf dxb source delta -k $COMPARE_WITH --json | jq -c '.result.deltaMeta[] | select (endswith(".cls"))' | paste -sd, - | sed 's/"//g' > apexclasses
            cat $OUTPUT_DIR/package.xml
            
            if [ "$TEST_LEVEL" = "RunSpecifiedTests" ]; then 
              echo "sf dxb source fetchtest -x $OUTPUT_DIR/package.xml -t $CHANGE_DETECTION_TYPE --test-class-name-regex $TEST_CLASS_REGEX -d . > testClasses"
              sf dxb source fetchtest -x $OUTPUT_DIR/package.xml -t $CHANGE_DETECTION_TYPE --test-class-name-regex $TEST_CLASS_REGEX -d . > testClasses    
              cat testClasses
            fi
            echo "::set-output name=noChanges::false" # Changes found, proceed

          fi
        shell: bash
        
        # 3. âš™ï¸ Set Specific Org Data (New Conditional Step)
      - name: âš™ï¸ Set Specific Org Data
        if: ${{ inputs.org-preconfig == true }}
        run: |
          TARGETENV= ${{ inputs.target-env }}
          # Check if the output of 'sfdx-env-mapping' is non-empty
          if [[ -s "${{ vars.ORG_SPEC_METADATA_DEF }}" ]]; then
            CONFIG_FILE="${{ vars.ORG_SPEC_METADATA_DEF }}"
            echo "Running: sf dxb org data --config $CONFIG_FILE --environment $TARGETENV"
            sf dxb org data --config "$CONFIG_FILE" --environment "$TARGETENV"
          else
            echo "Org. Spec Metadata Def file is empty or not found. Skipping 'Set Specific Org Data'. Go to Settings > Environment and add variable 'ORG_SPEC_METADATA_DEF' with the path of your file."
          fi
        shell: bash
        
      - name: ðŸ›¡ï¸ Run Code Analyzer
        id: code_analyzer
        continue-on-error: true # Azure's 'continueOnError: true'
        if: ${{ inputs.run-code-scanner == true }}
        run: |
          # apexclasses file was generated in the 'Calculate Delta' step.
          # It contains a comma-separated list of changed Apex class paths.
          APEX_CLASSES=$(cat apexclasses)
          
          # Check if the file content is NOT empty/just whitespace, similar to Azure's 'if [[ ! -z "$apexclasses" ]]'
          if [[ -s apexclasses ]]; then
            echo "--- Starting Code Scan on $APEX_CLASSES ---"
            
            # Create output directory
            mkdir -p codeanalyzeroutput
            
            # Run the scan. We use the SEVERITY_THRESHOLD env var defined earlier.
            sf code-analyzer run \
              -t "$APEX_CLASSES" \
              -f "codeanalyzeroutput/code-scanner-results.html" \
            
            # Set output variable to track if a report was generated (equivalent to Azure's task.setvariable)
            echo "codeScannerReportExists=true" >> $GITHUB_OUTPUT
          
          else
            echo "Nothing to scan (apexclasses file is empty)."
            echo "codeScannerReportExists=false" >> $GITHUB_OUTPUT
          fi
        shell: bash
        
      - name: ðŸ“¤ Publish Code Analyzer Report
        uses: actions/upload-artifact@v4
        
        if: ${{ steps.code_analyzer.outputs.codeScannerReportExists == 'true' }}
        with:
          name: Code-Analyzer-Report-${{ inputs.target-env }}
          path: codeanalyzeroutput/code-scanner-results.html
          
          retention-days: 7
