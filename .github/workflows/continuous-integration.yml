name: Salesforce CI/CD Logic

# This workflow can ONLY be called from another repository
on:
  workflow_call:
    inputs:
      target-env:
        description: 'Salesforce Target Environment Alias (e.g., sandbox, prod)'
        required: true
        type: string
      deployment-mode:
        description: 'Deployment Mode (DELTA or FULL)'
        required: true
        type: string
      test-level:
        description: 'Test Level (NoTestRun, RunLocalTests, RunSpecifiedTests)'
        required: true
        type: string
      check-only:
        description: 'Run deployment as check-only (validation)'
        required: true
        type: boolean
      delta-mode:
        description: 'Deployment Mode (DELTA or FULL)'
        required: true
        type: string
      compare-with:
        description: 'Git branch to compare against for Delta deployment'
        required: true
        type: string
      severity-threshold:
        description: 'Code Analyzer Severity Threshold'
        required: false
        type: string
        default: '2'
      min-code-coverage:
        description: 'Minimum Apex Code Coverage Percentage (optional)'
        required: false
        type: string
        default: ''
      outputdir:
        description: 'Output directory for artifacts'
        required: false
        type: string
        default: 'results'
      change-detection-type:
        description: 'Metadata type for test class detection (e.g., classes, all)'
        required: false
        type: string
        default: 'classes'
      test-class-regex: 
        description: 'Regex for matching test class names'
        required: false
        type: string
        default: '.*Test.*$'
    secrets:
      # FIX: The reusable workflow must explicitly define the secret it expects by name
      SFDX_AUTH_URL:
        description: 'The Salesforce Auth URL secret value passed by the caller'
        required: true

jobs:
  salesforce_ci:
    runs-on: ubuntu-latest
    container: brovasi/dxb

    env:
      # Map inputs to environment variables used in the script
      TARGET_ENV: ${{ inputs.target-env }}
      DEPLOYMENT_MODE: ${{ inputs.deployment-mode }}
      DELTA_MODE: ${{ inputs.delta-mode }}
      TEST_LEVEL: ${{ inputs.test-level }}
      SEVERITY_THRESHOLD: ${{ inputs.severity-threshold }}
      CHECK_ONLY: ${{ inputs.check-only }}
      MIN_CODE_COVERAGE: ${{ inputs.min-code-coverage }}
      COMPARE_WITH: ${{ inputs.compare-with }}
      
      # FIX: Using inputs directly instead of hardcoding utility variables
      OUTPUT_DIR: ${{ inputs.outputdir }}
      CHANGE_DETECTION_TYPE: ${{ inputs.change-detection-type }}
      TEST_CLASS_REGEX: ${{ inputs.test-class-regex }}

    steps:
      - name: â¬‡ï¸ Checkout Repository (Salesforce Project)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      # 1. Login to Salesforce (using the common, fixed secret SFDX_AUTH_URL)
      - name: ðŸ”‘ Salesforce Login
        run: |
          # FIX: Access the secret using the fixed secret key defined in 'on:workflow_call:secrets'
          AUTH_URL_VALUE="${{ secrets.SFDX_AUTH_URL }}"
          
          if [ -z "$AUTH_URL_VALUE" ]; then
            echo "::error::SFDX Auth URL secret not found. Ensure the calling workflow passes the secret via the 'SFDX_AUTH_URL' key."
            exit 1
          fi
          
          echo "$AUTH_URL_VALUE" > credentials.txt
          # Use the environment variable $TARGET_ENV
          sf org login sfdx-url -f credentials.txt -a $TARGET_ENV -s
        shell: bash

      # 2. Run Delta
      - name: ðŸ§® Calculate Delta
        # Set ID to allow checking for changes later
        id: delta_calc
        run: |
          # Use environment variables which are easier to read and less error-prone
          if [ "$DEPLOYMENT_MODE" = "FULL" ]
          then
            echo "--- Full Deployment Mode ---"
            allPackageDirectories=""
            json=$(cat sfdx-project.json)
            for i in $(echo "$json" | jq -r '.packageDirectories[].path'); do
              allPackageDirectories+=" --source-dir $i"
            done
            echo "sf project generate manifest $allPackageDirectories -d $OUTPUT_DIR"
            sf project generate manifest $allPackageDirectories -d $OUTPUT_DIR
            
            # Setup for full deployment tests
            echo "./**/*.cls" > apexclasses
            echo "" > testClasses
            echo "::set-output name=noChanges::false" # Force deployment if FULL mode

          else # DELTA Deployment Mode
            echo "--- Delta Deployment Mode (Comparing with $COMPARE_WITH) ---"
            git config diff.renameLimit 999999
            
            # 1. Generate package.xml and check for changes
            echo "sf dxb source delta -m $DELTA_MODE -k $COMPARE_WITH -p $OUTPUT_DIR -g"
            sf dxb source delta -m $DELTA_MODE -k $COMPARE_WITH -p $OUTPUT_DIR -g
            
            # Check if package.xml contains actual metadata members
            if ! grep -q '<members>' "$OUTPUT_DIR/package.xml"; then
              echo "No changes detected. Skipping deployment."
              echo "::set-output name=noChanges::true"
              exit 0
            fi

            # 2. Extract Apex classes and test classes for specified tests
            sf dxb source delta -k $COMPARE_WITH --json | jq -c '.result.deltaMeta[] | select (endswith(".cls"))' | paste -sd, - | sed 's/"//g' > apexclasses
            cat $OUTPUT_DIR/package.xml
            
            if [ "$TEST_LEVEL" = "RunSpecifiedTests" ]; then 
              echo "sf dxb source fetchtest -x $OUTPUT_DIR/package.xml -t $CHANGE_DETECTION_TYPE --test-class-name-regex $TEST_CLASS_REGEX -d . > testClasses"
              sf dxb source fetchtest -x $OUTPUT_DIR/package.xml -t $CHANGE_DETECTION_TYPE --test-class-name-regex $TEST_CLASS_REGEX -d . > testClasses    
              cat testClasses
            fi
            echo "::set-output name=noChanges::false" # Changes found, proceed

          fi
        shell: bash
