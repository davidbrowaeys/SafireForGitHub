name: Salesforce CI/CD Logic

# This workflow can ONLY be called from another repository
on:
  workflow_call:
    inputs:
      target-env:
        description: 'Salesforce Target Environment Alias (e.g., sandbox, prod)'
        required: true
        type: string
      deployment-mode:
        description: 'Deployment Mode (DELTA or FULL)'
        required: true
        type: string
      test-level:
        description: 'Test Level (NoTestRun, RunLocalTests, RunSpecifiedTests)'
        required: true
        type: string
      check-only:
        description: 'Run deployment as check-only (validation)'
        required: true
        type: boolean
      compare-with:
        description: 'Git branch to compare against for Delta deployment'
        required: true
        type: string
      severity-threshold:
        description: 'Code Analyzer Severity Threshold'
        required: false
        type: string
        default: '2'
      min-code-coverage:
        description: 'Minimum Apex Code Coverage Percentage (optional)'
        required: false
        type: string
        default: ''
      auth-url-secret-name:
        description: 'GitHub Secret name containing the SFDX Auth URL'
        required: true
        type: string

jobs:
  salesforce_ci:
    runs-on: ubuntu-latest
    container: brovasi/dxb

    env:
      # Map inputs to environment variables used in the script
      TARGET_ENV: ${{ inputs.target-env }}
      SFDX_AUTH_URL_SECRET_NAME: ${{ inputs.auth-url-secret-name }}
      DEPLOYMENT_MODE: ${{ inputs.deployment-mode }}
      TEST_LEVEL: ${{ inputs.test-level }}
      SEVERITY_THRESHOLD: ${{ inputs.severity-threshold }}
      CHECK_ONLY: ${{ inputs.check-only }}
      MIN_CODE_COVERAGE: ${{ inputs.min-code-coverage }}
      COMPARE_WITH: ${{ inputs.compare-with }}
      
      # Fixed utility variables
      OUTPUT_DIR: 'delta'
      CHANGE_DETECTION_TYPE: 'classes'
      TEST_CLASS_REGEX: '.*Test.*$'

    steps:
      - name: ‚¨áÔ∏è Checkout Repository (Salesforce Project)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 1. Login to Salesforce (using the secret passed from the caller)
      - name: üîë Salesforce Login
        run: |
          AUTH_URL_VALUE=$(echo "${{ secrets[env.SFDX_AUTH_URL_SECRET_NAME] }}")
          if [ -z "$AUTH_URL_VALUE" ]; then
            echo "::error::SFDX Auth URL secret not found. Check secret name and permissions."
            exit 1
          fi
          echo "$AUTH_URL_VALUE" > credentials.txt
          sf org login sfdx-url -f credentials.txt -a $TARGET_ENV -s
        shell: bash
        # ... Remaining steps (Delta, Code Scan, Deploy, Publish) follow the logic from the previous answer ...

      # 2. Run Delta
      - name: üßÆ Calculate Delta
        id: delta_calc
        # ... (Same script logic as before, using env vars) ...

      # 3. Run Code Scanner
      - name: üõ°Ô∏è Run Code Analyzer
        id: code_scan
        if: steps.delta_calc.outputs.noChanges == 'false'
        # ... (Same script logic as before, using env vars) ...

      # 4. Deploy to Salesforce
      - name: üöÄ Deploy to Salesforce
        id: deploy
        if: steps.delta_calc.outputs.noChanges == 'false'
        # ... (Same script logic as before, using env vars and dynamic CHECK_ONLY) ...

      # 5. Publish Results
      - name: üìã Deployment Result & Verification
        id: publish_results
        if: always() && steps.delta_calc.outputs.noChanges == 'false'
        # ... (Same script logic as before, including `sf project deploy report` and `sf dxb apex coverage cleanup`) ...
        
      - name: ‚¨ÜÔ∏è Publish Code Coverage (Codecov)
        uses: codecov/codecov-action@v4
        if: steps.publish_results.outputs.TESTHASRUN == 'true'
        with:
          files: testresults/apex/coverage/cobertura.xml
          # Note: The Codecov token MUST be passed as a secret from the CALLING repository.
          token: ${{ secrets.CODECOV_TOKEN }} 

      - name: ‚¨ÜÔ∏è Publish JUnit Results (PR Decoration)
        uses: mikepenz/action-junit-report@v4
        if: steps.publish_results.outputs.TESTHASRUN == 'true'
        # ... (config as before) ...
