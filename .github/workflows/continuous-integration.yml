
name: Salesforce CI/CD Logic

# This workflow can ONLY be called from another repository
on:
  workflow_call:
    inputs:
      target-env:
        description: 'Salesforce Target Environment Alias (e.g., sandbox, prod)'
        required: true
        type: string
      deployment-mode:
        description: 'Deployment Mode (DELTA or FULL)'
        required: true
        type: string
      test-level:
        description: 'Test Level (NoTestRun, RunLocalTests, RunSpecifiedTests)'
        required: false
        type: string
      check-only:
        description: 'Run deployment as check-only (validation)'
        required: true
        type: boolean
      outputdir:
        description: 'Output directory for artifacts'
        required: false
        type: string
        default: 'results'
      change-detection-type:
        description: 'Metadata type for test class detection (e.g., classes, all)'
        required: false
        type: string
        default: 'classes'
      test-class-regex: 
        description: 'Regex for matching test class names'
        required: false
        type: string
        default: '.*Test.*$'
      org-preconfig:
        description: 'Run pre-deployment org configuration data step'
        required: false
        type: boolean
        default: false
      run-code-scanner:
        description: 'Run Salesforce code analyzer'
        required: false
        type: boolean
        default: false
      run-data-import: 
        description: Run data import
        required: false 
        type: boolean 
        default: false
      auto-publish-communities: 
        description: automatically publish all experience cloud communities
        required: false 
        type: boolean 
        default: false
      runjest: 
        description: run lwc test
        required: false 
        type: boolean 
        default: false
      jest-fail-on-error:
        description: 'Fail the workflow if LWC Jest tests fail'
        required: false
        type: boolean
        default: false

jobs:
  salesforce_ci:
    runs-on: ubuntu-latest
    container: brovasi/dxb
    environment: ${{ inputs.target-env }}

    env:
      TARGET_ENV: ${{ inputs.target-env }}
      DEPLOYMENT_MODE: ${{ inputs.deployment-mode }}
      CHECK_ONLY: ${{ inputs.check-only }}
      OUTPUT_DIR: ${{ inputs.outputdir }}

    steps:
      # ============================================================
      # INITIALIZATION
      # ============================================================
      - name: â¬‡ï¸ Checkout Repository (Salesforce Project)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â¬‡ï¸ Checkout Reusable Actions
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/SafireForGitHub
          path: .github/actions-repo
          sparse-checkout: |
            .github/actions
          sparse-checkout-cone-mode: false
      
      - name: ğŸ“ Setup Actions Directory
        run: |
          # Copy composite actions to the expected location
          cp -r .github/actions-repo/.github/actions/* .github/actions/ 2>/dev/null || mkdir -p .github/actions && cp -r .github/actions-repo/.github/actions/* .github/actions/
          rm -rf .github/actions-repo
        shell: bash
          
      - name: âš™ï¸ Initialize Pipeline
        id: init
        run: |
          # Set COMPARE_WITH based on check-only
          COMPARE_WITH="${{ inputs.check-only == true && vars.VAL_COMPARE_WITH || vars.DEP_COMPARE_WITH }}"
          
          # Set DELTA_MODE based on check-only
          DELTA_MODE="${{ inputs.check-only == true && vars.VAL_DELTA_MODE || vars.DEP_DELTA_MODE }}"
          
          # Set TEST_LEVEL using the nested condition
          TEST_LEVEL="${{ inputs.test-level != '' && inputs.test-level || (inputs.check-only == true && vars.VAL_TEST_LEVEL || vars.DEP_TEST_LEVEL) }}"
          
          # Export variables for subsequent steps
          echo "COMPARE_WITH=$COMPARE_WITH" >> $GITHUB_ENV
          echo "DELTA_MODE=$DELTA_MODE" >> $GITHUB_ENV
          echo "TEST_LEVEL=$TEST_LEVEL" >> $GITHUB_ENV

          # Create Configuration Summary
          echo "## âš™ï¸ CI/CD Configuration Summary" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target Environment** | ${{ inputs.target-env }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment Mode | ${{ inputs.deployment-mode }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Delta Mode | $DELTA_MODE |" >> $GITHUB_STEP_SUMMARY
          echo "| Compare With | \`$COMPARE_WITH\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Check Only (Validation)** | ${{ inputs.check-only }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Level | $TEST_LEVEL |" >> $GITHUB_STEP_SUMMARY
          echo "| Run Code Scanner | ${{ inputs.run-code-scanner }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Run Org Pre-Config | ${{ inputs.org-preconfig }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Install dependencies and setup plugins
          npm install --save-dev
          sf plugins link $(npm root -g)/dxb
          sf plugins
          git config --global --add safe.directory $PWD
        shell: bash

      # ============================================================
      # COMPOSITE ACTIONS
      # ============================================================
      
      # 1. Salesforce Authentication
      - name: ğŸ”‘ Salesforce Login
        uses: ./.github/actions/sf-auth
        with:
          target-env: ${{ inputs.target-env }}
          auth-url: ${{ secrets.AUTH_URL }}

      # 2. Calculate Delta
      - name: ğŸ§® Calculate Delta
        id: delta
        uses: ./.github/actions/sf-delta
        with:
          deployment-mode: ${{ inputs.deployment-mode }}
          delta-mode: ${{ env.DELTA_MODE }}
          compare-with: ${{ env.COMPARE_WITH }}
          output-dir: ${{ inputs.outputdir }}
          test-level: ${{ env.TEST_LEVEL }}
          change-detection-type: ${{ inputs.change-detection-type }}
          test-class-regex: ${{ inputs.test-class-regex }}

      # 3. Org Pre-Configuration (Conditional)
      - name: âš™ï¸ Set Specific Org Data
        if: ${{ inputs.org-preconfig == true }}
        uses: ./.github/actions/sf-org-preconfig
        with:
          target-env: ${{ inputs.target-env }}
          config-file: ${{ vars.ORG_SPEC_METADATA_DEF }}

      # 4. Code Scanner (Conditional)
      - name: ğŸ›¡ï¸ Run Code Analyzer
        id: scanner
        if: ${{ inputs.run-code-scanner == true }}
        uses: ./.github/actions/sf-code-scanner
        with:
          apex-classes: ${{ steps.delta.outputs.apex-classes }}
          output-dir: codeanalyzeroutput
          severity: ${{ vars.SEVERITY_THRESHOLD }}

      # 5. Salesforce Deployment
      - name: ğŸš€ Salesforce Deployment
        id: deploy
        if: ${{ steps.delta.outputs.no-changes == 'false' }}
        uses: ./.github/actions/sf-deploy
        with:
          target-env: ${{ inputs.target-env }}
          package-xml: ${{ inputs.outputdir }}/package.xml
          test-level: ${{ env.TEST_LEVEL }}
          test-classes: ${{ steps.delta.outputs.test-classes }}
          check-only: ${{ inputs.check-only }}
          pre-destructive-path: ${{ vars.PRE_DESTRUCTIVE_XML_PATH }}
          post-destructive-path: ${{ vars.POST_DESTRUCTIVE_XML_PATH }}

      # 6. Coverage Cleanup and Checks
      - name: ğŸ§¹ Coverage Cleanup and Checks
        if: ${{ always() && steps.deploy.outputs.run-tests == 'true' }}
        uses: ./.github/actions/sf-coverage
        with:
          coverage-file: testresults/apex/coverage/cobertura.xml
          junit-file: testresults/apex/junit/junit.xml
          min-coverage: ${{ vars.MIN_CODE_COVERAGE }}
          check-performance: ${{ vars.CHECKPERFORMANCE }}
          check-only: ${{ inputs.check-only }}

      # 7. Data Import (Conditional - only on actual deployment)
      - name: ğŸ“¥ Run Data Import
        if: ${{ inputs.run-data-import == true && inputs.check-only == false && success() }}
        uses: ./.github/actions/sf-data-import
        with:
          data-def-file: ${{ vars.DATA_DEF_FILE }}
          data-dir: data

      # 8. Community Publish (Conditional - only on actual deployment)
      - name: ğŸŒ Publish Experience Cloud Community
        if: ${{ inputs.check-only == false && inputs.auto-publish-communities == true }}
        uses: ./.github/actions/sf-community-publish
        with:
          target-env: ${{ inputs.target-env }}

      # 9. LWC Jest Tests (Conditional)
      - name: ğŸ§ª Run LWC Jest Tests
        if: ${{ inputs.runjest == true }}
        uses: ./.github/actions/sf-jest
        with:
          deployment-mode: ${{ inputs.deployment-mode }}
          package-xml: ${{ inputs.outputdir }}/package.xml
          fail-on-error: ${{ inputs.jest-fail-on-error }}
          output-dir: testresults/lwc

      # 10. Generate Report and Upload Artifacts
      - name: ğŸ“Š Generate Report and Upload Artifacts
        if: ${{ always() }}
        uses: ./.github/actions/sf-report
        with:
          package-xml: ${{ inputs.outputdir }}/package.xml
          deploy-result: deployResult.json
          junit-file: testresults/apex/junit/junit.xml
          coverage-file: testresults/apex/coverage/cobertura.xml
          scanner-report: codeanalyzeroutput/code-scanner-results.csv
          target-env: ${{ inputs.target-env }}
          run-tests: ${{ steps.deploy.outputs.run-tests }}
          scanner-report-exists: ${{ steps.scanner.outputs.report-exists }}
          min-severity: ${{ vars.SEVERITY_THRESHOLD }}

      # 11. Delete Obsolete Flows (Conditional - only on actual deployment)
      - name: ğŸ—‘ï¸ Delete Obsolete Flows
        if: ${{ vars.DELETE_OBSOLETE_FLOWS == 'true' && inputs.check-only == false && success() }}
        uses: ./.github/actions/sf-delete-obsolete-flow
        with:
          target-env: ${{ inputs.target-env }}

      # 12. Create Git Tag (only on successful actual deployment)
      - name: ğŸ·ï¸ Create Git Tag
        if: ${{ inputs.check-only == false && steps.deploy.conclusion == 'success' && steps.delta.outputs.no-changes == 'false' }}
        uses: ./.github/actions/git-tag
        with:
          prefix: ${{ inputs.target-env }}
