name: Salesforce CI/CD Logic

# This workflow can ONLY be called from another repository
on:
  workflow_call:
    inputs:
      target-env:
        description: 'Salesforce Target Environment Alias (e.g., sandbox, prod)'
        required: true
        type: string
      deployment-mode:
        description: 'Deployment Mode (DELTA or FULL)'
        required: true
        type: string
      test-level:
        description: 'Test Level (NoTestRun, RunLocalTests, RunSpecifiedTests)'
        required: true
        type: string
      check-only:
        description: 'Run deployment as check-only (validation)'
        required: true
        type: boolean
      delta-mode:
        description: ''
        required: true
        type: string
      compare-with:
        description: 'Git branch to compare against for Delta deployment'
        required: true
        type: string
      severity-threshold:
        description: 'Code Analyzer Severity Threshold'
        required: false
        type: string
        default: '2'
      min-code-coverage:
        description: 'Minimum Apex Code Coverage Percentage (optional)'
        required: false
        type: string
        default: ''
      outputdir:
        description: ''
        required: false
        type: string
        default: 'results'
      change-detection-type:
        description: ''
        required: false
        type: string
        default: 'classes'
      test-class-regex: 
        description: ''
        required: false
        type: string
        default: '.*Test.*$'

jobs:
  salesforce_ci:
    runs-on: ubuntu-latest
    container: brovasi/dxb

    env:
      # Map inputs to environment variables used in the script
      TARGET_ENV: ${{ inputs.target-env }}
      DEPLOYMENT_MODE: ${{ inputs.deployment-mode }}
      TEST_LEVEL: ${{ inputs.test-level }}
      SEVERITY_THRESHOLD: ${{ inputs.severity-threshold }}
      CHECK_ONLY: ${{ inputs.check-only }}
      MIN_CODE_COVERAGE: ${{ inputs.min-code-coverage }}
      COMPARE_WITH: ${{ inputs.compare-with }}
      
      # Fixed utility variables
      OUTPUT_DIR: 'delta'
      CHANGE_DETECTION_TYPE: 'classes'
      TEST_CLASS_REGEX: '.*Test.*$'

    steps:
      - name: ‚¨áÔ∏è Checkout Repository (Salesforce Project)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 1. Login to Salesforce (using the secret passed from the caller)
      - name: üîë Salesforce Login
        run: |
          AUTH_URL_VALUE=$(echo "${{ secrets.AUTH_URL }}")
          if [ -z "$AUTH_URL_VALUE" ]; then
            echo "::error::SFDX Auth URL secret not found. Check secret name and permissions."
            exit 1
          fi
          echo "$AUTH_URL_VALUE" > credentials.txt
          sf org login sfdx-url -f credentials.txt -a $TARGET_ENV -s
        shell: bash

      # 2. Run Delta
      - name: üßÆ Calculate Delta
        run: |
          TESTLEVEL="${{ inputs.testlevel }}"
          DEPLOYMENTMODE="${{ inputs.deploymentMode }}"
          git config diff.renameLimit 999999
          if [ "$DEPLOYMENTMODE" = "FULL" ]
          then
            allPackageDirectories=""
            json=$(cat sfdx-project.json)
            for i in $(echo "$json" | jq -r '.packageDirectories[].path'); do
              allPackageDirectories+=" --source-dir $i"
            done
            echo "sf project generate manifest $allPackageDirectories -d ${{ inputs.outputdir }}"
            sf project generate manifest $allPackageDirectories -d ${{ inputs.outputdir }}
            echo "./**/*.cls" > apexclasses
            echo "" > testClasses
          else 
            echo "git branch"
            git branch
            echo "sf dxb source delta -m ${{ inputs.delta-mode }} -k ${{ inputs.compare-with }} -p ${{ inputs.outputdir }} -g"
            sf dxb source delta -m ${{ inputs.delta-mode }} -k ${{ inputs.compare-with }} -p ${{ inputs.outputdir }} -g
            sf dxb source delta -m ${{ inputs.delta-mode }} -k ${{ inputs.compare-with }} --json | jq -c '.result.deltaMeta[] | select (endswith(".cls"))' | paste -sd, - | sed 's/"//g' > apexclasses
            cat ${{ inputs.outputdir }}/package.xml
            if [ "$TESTLEVEL" = "RunSpecifiedTests" ]
            then 
              echo "sf dxb source fetchtest -x ${{ inputs.outputdir }}/package.xml -t ${{ inputs.change-detection-type }} --test-class-name-regex ${{ inputs.test-class-regex }} -d . > testClasses"
              sf dxb source fetchtest -x ${{ inputs.outputdir }}/package.xml -t ${{ inputs.change-detection-type }} --test-class-name-regex ${{ inputs.test-class-regex }} -d .> testClasses    
              cat testClasses
            fi
          fi
        shell: bash
      # # 3. Run Code Scanner
      # - name: üõ°Ô∏è Run Code Analyzer
      #   id: code_scan
      #   if: steps.delta_calc.outputs.noChanges == 'false'
      #   # ... (Same script logic as before, using env vars) ...

      # # 4. Deploy to Salesforce
      # - name: üöÄ Deploy to Salesforce
      #   id: deploy
      #   if: steps.delta_calc.outputs.noChanges == 'false'
      #   # ... (Same script logic as before, using env vars and dynamic CHECK_ONLY) ...
        
      # # 5. Deployment Result, Coverage, and Test Publishing (Remains the same)
      # - name: üìã Deployment Result & Verification
      #   id: publish_results
      #   if: always() && steps.delta_calc.outputs.noChanges == 'false'
      #   run: |
      #     # ... (unchanged logic for checking success and retrieving report, 
      #     # which generates testresults/apex/coverage/cobertura.xml) ...
      
      # # ‚û°Ô∏è NEW STEP: Publish Code Coverage natively using GitHub Check
      # - name: ‚¨ÜÔ∏è Publish Code Coverage Check
      #   uses: marketplace/action-code-coverage@v2
      #   if: steps.publish_results.outputs.TESTHASRUN == 'true'
      #   with:
      #     # Points to the file generated by the Salesforce report command
      #     token: ${{ github.token }}
      #     filename: testresults/apex/coverage/cobertura.xml
      #     # Set the name for the check visible on the PR/Commit
      #     name: Apex Code Coverage Report
      #     # Set the minimum coverage threshold (using the input passed to the workflow)
      #     minimum_coverage: ${{ inputs.min-code-coverage }}
          # Fail the step if minimum coverage is not met
          fail_on_below_threshold: true
